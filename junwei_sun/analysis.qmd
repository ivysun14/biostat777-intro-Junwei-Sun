---
title: "Example Analysis"
subtitle: "Survival after malignant melanoma surgery"
bibliography: references.bib
---

## Question

The goal of this analysis is to answer the question:  

> **How are survival and mortality after melanoma surgery associated with tumor ulceration, tumor thickness, and patient age?**

More specifically, we will:

- Estimate the **overall incidence rate** of death in the cohort.  
- Compare incidence rates and survival curves between patients **with vs. without ulceration** and with different **tumor thickness**.
- Explore how **age groups (tertiles)** relate to survival patterns.

::: {.callout-note}
## Why survival analysis?

In melanoma, *when* a patient dies is as important as *whether* they die. Time-to-event methods such as the Kaplan–Meier curves and log-rank tests allow us to use information from censored patients (those still alive at last follow-up) rather than discarding them.
:::


## Intended Audience

This analysis is intended for:

- Students in **biostatistics / epidemiology** learning or reviewing survival analysis concepts.
- **Healthcare professionals** looking for a reproducible example of survival analysis in R.


## Data

We use the `Melanoma` dataset from the **MASS** package in R, which contains data on 205 patients in Denmark with malignant melanoma who underwent surgery. The original data are described in *Statistical Models Based on Counting Processes* [@andersen1993]. The R help page for the dataset can be accessed via:

- `?MASS::Melanoma` inside R.


### Data Dictionary

| Variable         | Type        | Description                                                                 |
|------------------|------------ |-----------------------------------------------------------------------------|
| `time`           | numeric     | Time to death or censoring (days)                                           |
| `status`         | integer     | 1 = died from melanoma, 2 = alive, 3 = died from other causes               |
| `sex`            | integer     | 0 = female, 1 = male                                                        |
| `age`            | numeric     | Age at time of surgery (years)                                              |
| `year`           | integer     | Year of operation                                                           |
| `thickness`      | numeric     | Tumor thickness (mm)                                                        |
| `ulcer`          | integer     | 0 = no ulceration, 1 = ulceration present                                   |

You can also find this information at `?MASS::Melanoma` inside R.


## Survival Analysis Key Concepts

Survival analysis refers to statistical methods used to analyze **time-to-event** data. In other words how long it takes for a specific event (such as death, relapse, or recovery) to occur. Most of the information below are adapted from @https://doi.org/10.1016/j.pmrj.2016.04.003.

### 1. Time
The **time variable** represents how long each subject was followed in the study. It begins at the time of entry (e.g., surgery or diagnosis) and ends at either:

- the time the event happened, or  
- the last time the subject was observed (if the event never happened).

### 2. Event
The **event** is the outcome of interest (most commonly death). It is normally a binary variable that records whether or not a
subject had the event of interest.

### 3. Censoring
Subjects who have **not yet experienced the event** by the end of observation are said to be **censored**. Censoring means we know the subject was event-free for a certain time, but not what happened afterward. This allows researchers to use partial information from everyone in the study.

> Example: A patient followed for 5 years without relapse is censored at 5 years — we know they were relapse-free for 5 years, but not beyond potentially due to loss of followup.

### 4. Incidence Rate
The **incidence rate** measures how frequently new events occur over time.
\begin{equation*}
    \text{Incidence rate} = \frac{\text{Number of events}}{\text{Total person-time at risk}}
\end{equation*} 
It is often expressed per 100 person-years. For example, an incidence rate of 5 deaths per 100 person-years means 5 deaths are expected for every 100 years of follow-up time.

### 5. Survival Curve
A **Kaplan–Meier curve** shows the estimated probability of surviving over time. The curve starts at 100% (everyone is event-free initially) and decreases as events occur.  
- The **y-axis** shows survival probability (from 1 to 0).  
- The **x-axis** shows time since entry.  
- The curve steps downward as events accumulate.  

![A cartoon example of survival curve showing the survival of ten biscuits. This figure is taken from @lockwood2020survival](https://content.theinformationlab.co.uk/images/2020/06/image-1-1024x493.png)

::: {.callout-tip}
The **steeper** the curve, the **higher** the event rate; if two curves diverge, it suggests a difference in survival between groups.
:::


## Analysis

### Setup

```{r}
#| label: setup
#| message: false
#| include: true

library(MASS)
library(dplyr)
library(tidyr)
library(ggplot2)
library(survival)
library(broom)
```


### Data wrangling

Here we:
1. Load the Melanoma dataset.
2. Convert time from days to years.
3. Collapse original status into a binary event indicator (status_event).
4. Create factor variables for ulceration, sex, and tumor thickness group.
5. Create age tertiles.

::: {.column-margin}
**Note:**  
In this analysis we treat **all deaths** (from melanoma or other causes) as events when defining our outcome.
:::

```{r}
#| message: false
#| warning: false

melanoma_raw <- MASS::Melanoma

melanoma <- melanoma_raw %>%
    mutate(
        # convert follow-up time to years
        time_years = time / 365.25,
        # collapse status = 1 or 3 into "death" (1), status = 2 as alive (0)
        status_event = if_else(status %in% c(1, 3), 1L, 0L),
        # ulcer into factor
        ulcer_factor = factor(ulcer,
            levels = c(0, 1),
            labels = c("No ulcer", "Ulcer present")
        ),
        # sex into factor
        sex_factor = factor(sex,
            levels = c(0, 1),
            labels = c("Female", "Male")
        ),
        # define tumor thickness group
        thickness_group = if_else(thickness < 2, "< 2 mm", ">= 2 mm")
    ) %>%
    # drop rows with missing key variables
    drop_na(time_years, status_event)

# age tertiles
melanoma <- melanoma %>%
    mutate(
        age_tertile = ntile(age, 3),
        age_group = case_when(
            age_tertile == 1 ~ "Younger (lowest tertile)",
            age_tertile == 2 ~ "Middle (middle tertile)",
            age_tertile == 3 ~ "Older (highest tertile)"
        )
    )

# distribution of counts
melanoma %>% count(ulcer_factor, thickness_group, age_group)
```

### Overall incidence rate

```{r}
incidence_overall <- melanoma %>%
    summarise(
        deaths = sum(status_event),
        person_years = sum(time_years),
        rate_per_py = deaths / person_years,
        rate_per_100py = 100 * rate_per_py
    )

incidence_overall
```

The overall incidence rate is approximately 5.9 deaths per 100 person-years.

### Incidence rate by ulceration status

Next, we compare incidence rates between those with vs. without ulceration.

```{r}
#| label: incidence-ulcer

incidence_by_ulcer <- melanoma %>%
    group_by(ulcer_factor) %>%
    summarise(
        deaths = sum(status_event),
        person_years = sum(time_years),
        rate_per_100py = 100 * deaths / person_years,
        .groups = "drop"
    )

incidence_by_ulcer
```

In this case the group with ulceration has an incidence rate about 3 times higher.

### Incidence rate by thickness and ulceration

We first visualize distribution of tumor thickness in with ulceration and no ulceration groups.
```{r}
#| fig-cap: "Distribution of tumor thickness (mm) by ulceration status. The histogram shows that in the no ulceration group, more patients tend to have thinner tumor thickness."

ggplot(melanoma, aes(x = thickness)) +
    geom_histogram(bins = 30, boundary = 0) +
    facet_wrap(~ulcer_factor) +
    labs(
        title    = "Tumor thickness distribution by ulceration status",
        subtitle = "Melanoma patients treated surgically in Denmark",
        x        = "Tumor thickness (mm)",
        y        = "Number of patients"
    ) +
    theme_minimal()
```

```{r}
incidence_by_ulcer_thickness <- melanoma %>%
    group_by(thickness_group, ulcer_factor) %>%
    summarise(
        deaths = sum(status_event),
        person_years = sum(time_years),
        rate_per_100py = 100 * deaths / person_years,
        .groups = "drop"
    )

incidence_by_ulcer_thickness
```

```{r}
#| fig-cap: "Incidence rates of death by tumor thickness group and ulceration status. When ulcer is present, incidence rates tend to be higher. When both tumor thickness >=2 mm and there is a presence of ulceration, the incidence rate is significantly higher compared to all 3 other groups."

ggplot(
    incidence_by_ulcer_thickness,
    aes(
        x = thickness_group,
        y = rate_per_100py,
        fill = ulcer_factor
    )
) +
    geom_col(position = "dodge") +
    labs(
        title    = "Incidence rate of death by tumor thickness and ulceration",
        subtitle = "Rates expressed per 100 person-years of follow-up",
        x        = "Tumor thickness group",
        y        = "Incidence rate (deaths per 100 person-years)",
        fill     = "Ulceration"
    ) +
    theme_minimal()
```

### Kaplan–Meier curves by ulceration
```{r}
#| fig-cap: "Kaplan–Meier survival curves by ulceration status. The curves diverge which suggests there is a difference in survival probabilities between patients with ulceration and without."

fit_ulcer <- survfit(Surv(time_years, status_event) ~ ulcer_factor, data = melanoma)

km_ulcer_df <- broom::tidy(fit_ulcer) %>%
    mutate(ulcer_factor = gsub("ulcer_factor=", "", strata))

ggplot(km_ulcer_df, aes(x = time, y = estimate, color = ulcer_factor)) +
    geom_step() +
    labs(
        title    = "Survival after melanoma surgery by ulceration status",
        subtitle = "Kaplan–Meier estimates using all-cause mortality as the event",
        x        = "Time since surgery (years)",
        y        = "Estimated survival probability",
        color    = "Ulceration"
    ) +
    theme_minimal()
```

```{r}
summary(fit_ulcer)$table
```

```{r}
survdiff(Surv(time_years, status_event) ~ ulcer_factor, data = melanoma)
```

The median survival time for the ulcerated group was about 6.2 years. The log-rank test comparing two curves was highly significant ($p = 1 \times 10^{-7}$), indicating strong evidence of worse survival among those with ulceration.

### Kaplan–Meier curves by tumor thickness and ulceration

Next we add in tumor thickness and inspect the survival curves.

```{r}
#| fig-cap: "Kaplan–Meier survival curves by ulceration status and tumor thickness. The curve representing patients with a tumor thickness >= 2mm and ulceration diverge significantly from all other survival curves."

fit_thick_ulcer <- survfit(
    Surv(time_years, status_event) ~ thickness_group + ulcer_factor,
    data = melanoma
)

km_thick_ulcer_df <- broom::tidy(fit_thick_ulcer) %>%
    mutate(
        group = gsub("thickness_group=", "", strata),
        group = gsub("ulcer_factor=", "", group)
    )

ggplot(km_thick_ulcer_df, aes(x = time, y = estimate, color = group)) +
    geom_step() +
    labs(
        title = "Survival after melanoma surgery by thickness and ulceration",
        subtitle = "Kaplan–Meier estimates using all-cause mortality as the event",
        x = "Time since surgery (years)",
        y = "Estimated survival probability",
        color = "Group"
    ) +
    theme_minimal()
```

```{r}
survdiff(Surv(time_years, status_event) ~ thickness_group + ulcer_factor, data = melanoma)
```

Again we observed a highly significant log-rank test p-value ($1 \times 10^{-9}$), indicating there is significant difference in survival among 4 groups.

### Survival by age tertiles

Lasly we investigate whether different age groups have different survival outcomes after melanoma surgery.

```{r}
#| fig-cap: "Kaplan–Meier survival curves by age tertile. The youngest group seems to have the highest estimated survival probability towards the end of the study, whereas the middle age group and the elder group showed worse survival."

fit_age <- survfit(Surv(time_years, status_event) ~ age_group,
    data = melanoma
)

km_age_df <- broom::tidy(fit_age) %>%
    mutate(age_group = gsub("age_group=", "", strata))

ggplot(km_age_df, aes(x = time, y = estimate, color = age_group)) +
    geom_step() +
    labs(
        title    = "Survival after melanoma surgery by age tertile",
        subtitle = "Kaplan–Meier estimates using all-cause mortality as the event",
        x        = "Time since surgery (years)",
        y        = "Estimated survival probability",
        color    = "Age group"
    ) +
    theme_minimal()
```

```{r}
summary(fit_age)$table
```

```{r}
survdiff(Surv(time_years, status_event) ~ age_group, data = melanoma)
```

The log-rank test for age tertile is also significant ($p = 0.02$), showing that there is a significant difference in survival distributions among 3 different age groups.

## Summary of Results
In this analysis of 205 melanoma patients who underwent surgery, we estimated an overall incidence rate of death of about 5.9 deaths per 100 person-years. Patients with ulcerated tumors had a substantially higher incidence rate and worse Kaplan–Meier survival curves than those without ulceration; the incidence rate ratio was about 3.5, and the log-rank test comparing survival curves was highly significant ($p=1 \times 10^{-7}$). When inspecting tumor thickness and ulceration together, patients with ulceration and a higher tumor thickness showed significantly worse survival as well. Older age tertiles seem to be associated with worse survival, which is consistent with known prognostic factors in many healthcare problems as older patients tend to be more vulnerable to malignant diseases as well as complications after surgery. Altogether the analysis demonstrated potential risk factors for worse survival after melanoma surgery.

## Functions used

Below is a list of the core functions used from selected packages:

### dplyr

- `mutate()`
- `group_by()`  
- `summarise()`
- `count()` 
- `ntile()`
- `case_when()`

### tidyr

- `drop_na()`

### ggplot2

- `ggplot()`
- `geom_histogram()`
- `geom_step()`  
- `geom_col()`
- `facet_wrap()`  
- `theme_minimal()`