{
  "hash": "226cfa26641700b958ffc75c417e626a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Example Analysis\"\nsubtitle: \"Survival after malignant melanoma surgery\"\nbibliography: references.bib\n---\n\n## Question\n\nThe goal of this analysis is to answer the question:  \n\n> **How are survival and mortality after melanoma surgery associated with tumor ulceration, tumor thickness, and patient age?**\n\nMore specifically, we will:\n\n- Estimate the **overall incidence rate** of death in the cohort.  \n- Compare incidence rates and survival curves between patients **with vs. without ulceration** and with different **tumor thickness**.\n- Explore how **age groups (tertiles)** relate to survival patterns.\n\n::: {.callout-note}\n## Why survival analysis?\n\nIn melanoma, *when* a patient dies is as important as *whether* they die. Time-to-event methods such as the Kaplan–Meier curves and log-rank tests allow us to use information from censored patients (those still alive at last follow-up) rather than discarding them.\n:::\n\n\n## Intended Audience\n\nThis analysis is intended for:\n\n- Students in **biostatistics / epidemiology** learning or reviewing survival analysis concepts.\n- **Healthcare professionals** looking for a reproducible example of survival analysis in R.\n\n\n## Data\n\nWe use the `Melanoma` dataset from the **MASS** package in R, which contains data on 205 patients in Denmark with malignant melanoma who underwent surgery. The original data are described in *Statistical Models Based on Counting Processes* [@andersen1993]. The R help page for the dataset can be accessed via:\n\n- `?MASS::Melanoma` inside R.\n\n\n### Data Dictionary\n\n| Variable         | Type        | Description                                                                 |\n|------------------|------------ |-----------------------------------------------------------------------------|\n| `time`           | numeric     | Time to death or censoring (days)                                           |\n| `status`         | integer     | 1 = died from melanoma, 2 = alive, 3 = died from other causes               |\n| `sex`            | integer     | 0 = female, 1 = male                                                        |\n| `age`            | numeric     | Age at time of surgery (years)                                              |\n| `year`           | integer     | Year of operation                                                           |\n| `thickness`      | numeric     | Tumor thickness (mm)                                                        |\n| `ulcer`          | integer     | 0 = no ulceration, 1 = ulceration present                                   |\n\nYou can also find this information at `?MASS::Melanoma` inside R.\n\n\n## Survival Analysis Key Concepts\n\nSurvival analysis refers to statistical methods used to analyze **time-to-event** data. In other words how long it takes for a specific event (such as death, relapse, or recovery) to occur. Most of the information below are adapted from @https://doi.org/10.1016/j.pmrj.2016.04.003.\n\n### 1. Time\nThe **time variable** represents how long each subject was followed in the study. It begins at the time of entry (e.g., surgery or diagnosis) and ends at either:\n\n- the time the event happened, or  \n- the last time the subject was observed (if the event never happened).\n\n### 2. Event\nThe **event** is the outcome of interest (most commonly death). It is normally a binary variable that records whether or not a\nsubject had the event of interest.\n\n### 3. Censoring\nSubjects who have **not yet experienced the event** by the end of observation are said to be **censored**. Censoring means we know the subject was event-free for a certain time, but not what happened afterward. This allows researchers to use partial information from everyone in the study.\n\n> Example: A patient followed for 5 years without relapse is censored at 5 years — we know they were relapse-free for 5 years, but not beyond potentially due to loss of followup.\n\n### 4. Incidence Rate\nThe **incidence rate** measures how frequently new events occur over time.\n\\begin{equation*}\n    \\text{Incidence rate} = \\frac{\\text{Number of events}}{\\text{Total person-time at risk}}\n\\end{equation*} \nIt is often expressed per 100 person-years. For example, an incidence rate of 5 deaths per 100 person-years means 5 deaths are expected for every 100 years of follow-up time.\n\n### 5. Survival Curve\nA **Kaplan–Meier curve** shows the estimated probability of surviving over time. The curve starts at 100% (everyone is event-free initially) and decreases as events occur.  \n- The **y-axis** shows survival probability (from 1 to 0).  \n- The **x-axis** shows time since entry.  \n- The curve steps downward as events accumulate.  \n\n![A cartoon example of survival curve showing the survival of ten biscuits. This figure is taken from @lockwood2020survival](https://content.theinformationlab.co.uk/images/2020/06/image-1-1024x493.png)\n\n::: {.callout-tip}\nThe **steeper** the curve, the **higher** the event rate; if two curves diverge, it suggests a difference in survival between groups.\n:::\n\n\n## Analysis\n\n### Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(survival)\nlibrary(broom)\n```\n:::\n\n\n\n### Data wrangling\n\nHere we:\n1. Load the Melanoma dataset.\n2. Convert time from days to years.\n3. Collapse original status into a binary event indicator (status_event).\n4. Create factor variables for ulceration, sex, and tumor thickness group.\n5. Create age tertiles.\n\n::: {.column-margin}\n**Note:**  \nIn this analysis we treat **all deaths** (from melanoma or other causes) as events when defining our outcome.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelanoma_raw <- MASS::Melanoma\n\nmelanoma <- melanoma_raw %>%\n    mutate(\n        # convert follow-up time to years\n        time_years = time / 365.25,\n        # collapse status = 1 or 3 into \"death\" (1), status = 2 as alive (0)\n        status_event = if_else(status %in% c(1, 3), 1L, 0L),\n        # ulcer into factor\n        ulcer_factor = factor(ulcer,\n            levels = c(0, 1),\n            labels = c(\"No ulcer\", \"Ulcer present\")\n        ),\n        # sex into factor\n        sex_factor = factor(sex,\n            levels = c(0, 1),\n            labels = c(\"Female\", \"Male\")\n        ),\n        # define tumor thickness group\n        thickness_group = if_else(thickness < 2, \"< 2 mm\", \">= 2 mm\")\n    ) %>%\n    # drop rows with missing key variables\n    drop_na(time_years, status_event)\n\n# age tertiles\nmelanoma <- melanoma %>%\n    mutate(\n        age_tertile = ntile(age, 3),\n        age_group = case_when(\n            age_tertile == 1 ~ \"Younger (lowest tertile)\",\n            age_tertile == 2 ~ \"Middle (middle tertile)\",\n            age_tertile == 3 ~ \"Older (highest tertile)\"\n        )\n    )\n\n# distribution of counts\nmelanoma %>% count(ulcer_factor, thickness_group, age_group)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    ulcer_factor thickness_group                age_group  n\n1       No ulcer          < 2 mm  Middle (middle tertile) 27\n2       No ulcer          < 2 mm  Older (highest tertile) 25\n3       No ulcer          < 2 mm Younger (lowest tertile) 35\n4       No ulcer         >= 2 mm  Middle (middle tertile) 11\n5       No ulcer         >= 2 mm  Older (highest tertile) 10\n6       No ulcer         >= 2 mm Younger (lowest tertile)  7\n7  Ulcer present          < 2 mm  Middle (middle tertile) 10\n8  Ulcer present          < 2 mm  Older (highest tertile)  5\n9  Ulcer present          < 2 mm Younger (lowest tertile)  7\n10 Ulcer present         >= 2 mm  Middle (middle tertile) 20\n11 Ulcer present         >= 2 mm  Older (highest tertile) 28\n12 Ulcer present         >= 2 mm Younger (lowest tertile) 20\n```\n\n\n:::\n:::\n\n\n### Overall incidence rate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nincidence_overall <- melanoma %>%\n    summarise(\n        deaths = sum(status_event),\n        person_years = sum(time_years),\n        rate_per_py = deaths / person_years,\n        rate_per_100py = 100 * rate_per_py\n    )\n\nincidence_overall\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  deaths person_years rate_per_py rate_per_100py\n1     71     1208.279  0.05876125       5.876125\n```\n\n\n:::\n:::\n\n\nThe overall incidence rate is approximately 5.9 deaths per 100 person-years.\n\n### Incidence rate by ulceration status\n\nNext, we compare incidence rates between those with vs. without ulceration.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nincidence_by_ulcer <- melanoma %>%\n    group_by(ulcer_factor) %>%\n    summarise(\n        deaths = sum(status_event),\n        person_years = sum(time_years),\n        rate_per_100py = 100 * deaths / person_years,\n        .groups = \"drop\"\n    )\n\nincidence_by_ulcer\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 4\n  ulcer_factor  deaths person_years rate_per_100py\n  <fct>          <int>        <dbl>          <dbl>\n1 No ulcer          23         760.           3.02\n2 Ulcer present     48         448.          10.7 \n```\n\n\n:::\n:::\n\n\nIn this case the group with ulceration has an incidence rate about 3 times higher.\n\n### Incidence rate by thickness and ulceration\n\nWe first visualize distribution of tumor thickness in with ulceration and no ulceration groups.\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(melanoma, aes(x = thickness)) +\n    geom_histogram(bins = 30, boundary = 0) +\n    facet_wrap(~ulcer_factor) +\n    labs(\n        title    = \"Tumor thickness distribution by ulceration status\",\n        subtitle = \"Melanoma patients treated surgically in Denmark\",\n        x        = \"Tumor thickness (mm)\",\n        y        = \"Number of patients\"\n    ) +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![Distribution of tumor thickness (mm) by ulceration status. The histogram shows that in the no ulceration group, more patients tend to have thinner tumor thickness.](analysis_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nincidence_by_ulcer_thickness <- melanoma %>%\n    group_by(thickness_group, ulcer_factor) %>%\n    summarise(\n        deaths = sum(status_event),\n        person_years = sum(time_years),\n        rate_per_100py = 100 * deaths / person_years,\n        .groups = \"drop\"\n    )\n\nincidence_by_ulcer_thickness\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 5\n  thickness_group ulcer_factor  deaths person_years rate_per_100py\n  <chr>           <fct>          <int>        <dbl>          <dbl>\n1 < 2 mm          No ulcer          14         558.           2.51\n2 < 2 mm          Ulcer present      6         145.           4.12\n3 >= 2 mm         No ulcer           9         202.           4.44\n4 >= 2 mm         Ulcer present     42         302.          13.9 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n    incidence_by_ulcer_thickness,\n    aes(\n        x = thickness_group,\n        y = rate_per_100py,\n        fill = ulcer_factor\n    )\n) +\n    geom_col(position = \"dodge\") +\n    labs(\n        title    = \"Incidence rate of death by tumor thickness and ulceration\",\n        subtitle = \"Rates expressed per 100 person-years of follow-up\",\n        x        = \"Tumor thickness group\",\n        y        = \"Incidence rate (deaths per 100 person-years)\",\n        fill     = \"Ulceration\"\n    ) +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![Incidence rates of death by tumor thickness group and ulceration status. When ulcer is present, incidence rates tend to be higher. When both tumor thickness >=2 mm and there is a presence of ulceration, the incidence rate is significantly higher compared to all 3 other groups.](analysis_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n### Kaplan–Meier curves by ulceration\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_ulcer <- survfit(Surv(time_years, status_event) ~ ulcer_factor, data = melanoma)\n\nkm_ulcer_df <- broom::tidy(fit_ulcer) %>%\n    mutate(ulcer_factor = gsub(\"ulcer_factor=\", \"\", strata))\n\nggplot(km_ulcer_df, aes(x = time, y = estimate, color = ulcer_factor)) +\n    geom_step() +\n    labs(\n        title    = \"Survival after melanoma surgery by ulceration status\",\n        subtitle = \"Kaplan–Meier estimates using all-cause mortality as the event\",\n        x        = \"Time since surgery (years)\",\n        y        = \"Estimated survival probability\",\n        color    = \"Ulceration\"\n    ) +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![Kaplan–Meier survival curves by ulceration status. The curves diverge which suggests there is a difference in survival probabilities between patients with ulceration and without.](analysis_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(fit_ulcer)$table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                           records n.max n.start events     rmean se(rmean)\nulcer_factor=No ulcer          115   115     115     23 12.288255 0.5460706\nulcer_factor=Ulcer present      90    90      90     48  8.063745 0.7028958\n                             median  0.95LCL 0.95UCL\nulcer_factor=No ulcer            NA       NA      NA\nulcer_factor=Ulcer present 6.176591 4.150582      NA\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(Surv(time_years, status_event) ~ ulcer_factor, data = melanoma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\nsurvdiff(formula = Surv(time_years, status_event) ~ ulcer_factor, \n    data = melanoma)\n\n                             N Observed Expected (O-E)^2/E (O-E)^2/V\nulcer_factor=No ulcer      115       23     44.5      10.4      27.9\nulcer_factor=Ulcer present  90       48     26.5      17.3      27.9\n\n Chisq= 27.9  on 1 degrees of freedom, p= 1e-07 \n```\n\n\n:::\n:::\n\n\nThe median survival time for the ulcerated group was about 6.2 years. The log-rank test comparing two curves was highly significant ($p = 1 \\times 10^{-7}$), indicating strong evidence of worse survival among those with ulceration.\n\n### Kaplan–Meier curves by tumor thickness and ulceration\n\nNext we add in tumor thickness and inspect the survival curves.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_thick_ulcer <- survfit(\n    Surv(time_years, status_event) ~ thickness_group + ulcer_factor,\n    data = melanoma\n)\n\nkm_thick_ulcer_df <- broom::tidy(fit_thick_ulcer) %>%\n    mutate(\n        group = gsub(\"thickness_group=\", \"\", strata),\n        group = gsub(\"ulcer_factor=\", \"\", group)\n    )\n\nggplot(km_thick_ulcer_df, aes(x = time, y = estimate, color = group)) +\n    geom_step() +\n    labs(\n        title = \"Survival after melanoma surgery by thickness and ulceration\",\n        subtitle = \"Kaplan–Meier estimates using all-cause mortality as the event\",\n        x = \"Time since surgery (years)\",\n        y = \"Estimated survival probability\",\n        color = \"Group\"\n    ) +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![Kaplan–Meier survival curves by ulceration status and tumor thickness. The curve representing patients with a tumor thickness >= 2mm and ulceration diverge significantly from all other survival curves.](analysis_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(Surv(time_years, status_event) ~ thickness_group + ulcer_factor, data = melanoma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\nsurvdiff(formula = Surv(time_years, status_event) ~ thickness_group + \n    ulcer_factor, data = melanoma)\n\n                                                     N Observed Expected\nthickness_group=< 2 mm, ulcer_factor=No ulcer       87       14    33.24\nthickness_group=< 2 mm, ulcer_factor=Ulcer present  22        6     8.49\nthickness_group=>= 2 mm, ulcer_factor=No ulcer      28        9    11.22\nthickness_group=>= 2 mm, ulcer_factor=Ulcer present 68       42    18.06\n                                                    (O-E)^2/E (O-E)^2/V\nthickness_group=< 2 mm, ulcer_factor=No ulcer          11.138    21.022\nthickness_group=< 2 mm, ulcer_factor=Ulcer present      0.728     0.828\nthickness_group=>= 2 mm, ulcer_factor=No ulcer          0.438     0.523\nthickness_group=>= 2 mm, ulcer_factor=Ulcer present    31.745    42.996\n\n Chisq= 44.4  on 3 degrees of freedom, p= 1e-09 \n```\n\n\n:::\n:::\n\n\nAgain we observed a highly significant log-rank test p-value ($1 \\times 10^{-9}$), indicating there is significant difference in survival among 4 groups.\n\n### Survival by age tertiles\n\nLasly we investigate whether different age groups have different survival outcomes after melanoma surgery.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_age <- survfit(Surv(time_years, status_event) ~ age_group,\n    data = melanoma\n)\n\nkm_age_df <- broom::tidy(fit_age) %>%\n    mutate(age_group = gsub(\"age_group=\", \"\", strata))\n\nggplot(km_age_df, aes(x = time, y = estimate, color = age_group)) +\n    geom_step() +\n    labs(\n        title    = \"Survival after melanoma surgery by age tertile\",\n        subtitle = \"Kaplan–Meier estimates using all-cause mortality as the event\",\n        x        = \"Time since surgery (years)\",\n        y        = \"Estimated survival probability\",\n        color    = \"Age group\"\n    ) +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![Kaplan–Meier survival curves by age tertile. The youngest group seems to have the highest estimated survival probability towards the end of the study, whereas the middle age group and the elder group showed worse survival.](analysis_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(fit_age)$table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                   records n.max n.start events     rmean\nage_group=Middle (middle tertile)       68    68      68     22 10.569057\nage_group=Older (highest tertile)       68    68      68     30  9.226518\nage_group=Younger (lowest tertile)      69    69      69     19 11.634685\n                                   se(rmean)   median  0.95LCL 0.95UCL\nage_group=Middle (middle tertile)  0.7875148       NA 8.711841      NA\nage_group=Older (highest tertile)  0.8232380 7.616701 5.092402      NA\nage_group=Younger (lowest tertile) 0.6965044       NA       NA      NA\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvdiff(Surv(time_years, status_event) ~ age_group, data = melanoma)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\nsurvdiff(formula = Surv(time_years, status_event) ~ age_group, \n    data = melanoma)\n\n                                    N Observed Expected (O-E)^2/E (O-E)^2/V\nage_group=Middle (middle tertile)  68       22     24.5     0.259     0.396\nage_group=Older (highest tertile)  68       30     20.0     4.948     7.004\nage_group=Younger (lowest tertile) 69       19     26.4     2.093     3.365\n\n Chisq= 7.4  on 2 degrees of freedom, p= 0.02 \n```\n\n\n:::\n:::\n\n\nThe log-rank test for age tertile is also significant ($p = 0.02$), showing that there is a significant difference in survival distributions among 3 different age groups.\n\n## Summary of Results\nIn this analysis of 205 melanoma patients who underwent surgery, we estimated an overall incidence rate of death of about 5.9 deaths per 100 person-years. Patients with ulcerated tumors had a substantially higher incidence rate and worse Kaplan–Meier survival curves than those without ulceration; the incidence rate ratio was about 3.5, and the log-rank test comparing survival curves was highly significant ($p=1 \\times 10^{-7}$). When inspecting tumor thickness and ulceration together, patients with ulceration and a higher tumor thickness showed significantly worse survival as well. Older age tertiles seem to be associated with worse survival, which is consistent with known prognostic factors in many healthcare problems as older patients tend to be more vulnerable to malignant diseases as well as complications after surgery. Altogether the analysis demonstrated potential risk factors for worse survival after melanoma surgery.\n\n## Functions used\n\nBelow is a list of the core functions used from selected packages:\n\n### dplyr\n\n- `mutate()`\n- `group_by()`  \n- `summarise()`\n- `count()` \n- `ntile()`\n- `case_when()`\n\n### tidyr\n\n- `drop_na()`\n\n### ggplot2\n\n- `ggplot()`\n- `geom_histogram()`\n- `geom_step()`  \n- `geom_col()`\n- `facet_wrap()`  \n- `theme_minimal()`",
    "supporting": [
      "analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}