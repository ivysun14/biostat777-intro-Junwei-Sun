<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Example Analysis – Hello!</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Hello!</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./analysis.html" aria-current="page"> 
<span class="menu-text">Example analysis</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#question" id="toc-question" class="nav-link active" data-scroll-target="#question">Question</a></li>
  <li><a href="#intended-audience" id="toc-intended-audience" class="nav-link" data-scroll-target="#intended-audience">Intended Audience</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#data-dictionary" id="toc-data-dictionary" class="nav-link" data-scroll-target="#data-dictionary">Data Dictionary</a></li>
  </ul></li>
  <li><a href="#survival-analysis-key-concepts" id="toc-survival-analysis-key-concepts" class="nav-link" data-scroll-target="#survival-analysis-key-concepts">Survival Analysis Key Concepts</a>
  <ul class="collapse">
  <li><a href="#time" id="toc-time" class="nav-link" data-scroll-target="#time">1. Time</a></li>
  <li><a href="#event" id="toc-event" class="nav-link" data-scroll-target="#event">2. Event</a></li>
  <li><a href="#censoring" id="toc-censoring" class="nav-link" data-scroll-target="#censoring">3. Censoring</a></li>
  <li><a href="#incidence-rate" id="toc-incidence-rate" class="nav-link" data-scroll-target="#incidence-rate">4. Incidence Rate</a></li>
  <li><a href="#survival-curve" id="toc-survival-curve" class="nav-link" data-scroll-target="#survival-curve">5. Survival Curve</a></li>
  </ul></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling">Data wrangling</a></li>
  <li><a href="#overall-incidence-rate" id="toc-overall-incidence-rate" class="nav-link" data-scroll-target="#overall-incidence-rate">Overall incidence rate</a></li>
  <li><a href="#incidence-rate-by-ulceration-status" id="toc-incidence-rate-by-ulceration-status" class="nav-link" data-scroll-target="#incidence-rate-by-ulceration-status">Incidence rate by ulceration status</a></li>
  <li><a href="#incidence-rate-by-thickness-and-ulceration" id="toc-incidence-rate-by-thickness-and-ulceration" class="nav-link" data-scroll-target="#incidence-rate-by-thickness-and-ulceration">Incidence rate by thickness and ulceration</a></li>
  <li><a href="#kaplanmeier-curves-by-ulceration" id="toc-kaplanmeier-curves-by-ulceration" class="nav-link" data-scroll-target="#kaplanmeier-curves-by-ulceration">Kaplan–Meier curves by ulceration</a></li>
  <li><a href="#kaplanmeier-curves-by-tumor-thickness-and-ulceration" id="toc-kaplanmeier-curves-by-tumor-thickness-and-ulceration" class="nav-link" data-scroll-target="#kaplanmeier-curves-by-tumor-thickness-and-ulceration">Kaplan–Meier curves by tumor thickness and ulceration</a></li>
  <li><a href="#survival-by-age-tertiles" id="toc-survival-by-age-tertiles" class="nav-link" data-scroll-target="#survival-by-age-tertiles">Survival by age tertiles</a></li>
  </ul></li>
  <li><a href="#summary-of-results" id="toc-summary-of-results" class="nav-link" data-scroll-target="#summary-of-results">Summary of Results</a></li>
  <li><a href="#functions-used" id="toc-functions-used" class="nav-link" data-scroll-target="#functions-used">Functions used</a>
  <ul class="collapse">
  <li><a href="#dplyr" id="toc-dplyr" class="nav-link" data-scroll-target="#dplyr">dplyr</a></li>
  <li><a href="#tidyr" id="toc-tidyr" class="nav-link" data-scroll-target="#tidyr">tidyr</a></li>
  <li><a href="#ggplot2" id="toc-ggplot2" class="nav-link" data-scroll-target="#ggplot2">ggplot2</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Example Analysis</h1>
<p class="subtitle lead">Survival after malignant melanoma surgery</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="question" class="level2">
<h2 class="anchored" data-anchor-id="question">Question</h2>
<p>The goal of this analysis is to answer the question:</p>
<blockquote class="blockquote">
<p><strong>How are survival and mortality after melanoma surgery associated with tumor ulceration, tumor thickness, and patient age?</strong></p>
</blockquote>
<p>More specifically, we will:</p>
<ul>
<li>Estimate the <strong>overall incidence rate</strong> of death in the cohort.<br>
</li>
<li>Compare incidence rates and survival curves between patients <strong>with vs.&nbsp;without ulceration</strong> and with different <strong>tumor thickness</strong>.</li>
<li>Explore how <strong>age groups (tertiles)</strong> relate to survival patterns.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Why survival analysis?
</div>
</div>
<div class="callout-body-container callout-body">
<p>In melanoma, <em>when</em> a patient dies is as important as <em>whether</em> they die. Time-to-event methods such as the Kaplan–Meier curves and log-rank tests allow us to use information from censored patients (those still alive at last follow-up) rather than discarding them.</p>
</div>
</div>
</section>
<section id="intended-audience" class="level2">
<h2 class="anchored" data-anchor-id="intended-audience">Intended Audience</h2>
<p>This analysis is intended for:</p>
<ul>
<li>Students in <strong>biostatistics / epidemiology</strong> learning or reviewing survival analysis concepts.</li>
<li><strong>Healthcare professionals</strong> looking for a reproducible example of survival analysis in R.</li>
</ul>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>We use the <code>Melanoma</code> dataset from the <strong>MASS</strong> package in R, which contains data on 205 patients in Denmark with malignant melanoma who underwent surgery. The original data are described in <em>Statistical Models Based on Counting Processes</em> <span class="citation" data-cites="andersen1993">(<a href="#ref-andersen1993" role="doc-biblioref">Andersen et al. 1993</a>)</span>. The R help page for the dataset can be accessed via:</p>
<ul>
<li><code>?MASS::Melanoma</code> inside R.</li>
</ul>
<section id="data-dictionary" class="level3">
<h3 class="anchored" data-anchor-id="data-dictionary">Data Dictionary</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 11%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>time</code></td>
<td>numeric</td>
<td>Time to death or censoring (days)</td>
</tr>
<tr class="even">
<td><code>status</code></td>
<td>integer</td>
<td>1 = died from melanoma, 2 = alive, 3 = died from other causes</td>
</tr>
<tr class="odd">
<td><code>sex</code></td>
<td>integer</td>
<td>0 = female, 1 = male</td>
</tr>
<tr class="even">
<td><code>age</code></td>
<td>numeric</td>
<td>Age at time of surgery (years)</td>
</tr>
<tr class="odd">
<td><code>year</code></td>
<td>integer</td>
<td>Year of operation</td>
</tr>
<tr class="even">
<td><code>thickness</code></td>
<td>numeric</td>
<td>Tumor thickness (mm)</td>
</tr>
<tr class="odd">
<td><code>ulcer</code></td>
<td>integer</td>
<td>0 = no ulceration, 1 = ulceration present</td>
</tr>
</tbody>
</table>
<p>You can also find this information at <code>?MASS::Melanoma</code> inside R.</p>
</section>
</section>
<section id="survival-analysis-key-concepts" class="level2">
<h2 class="anchored" data-anchor-id="survival-analysis-key-concepts">Survival Analysis Key Concepts</h2>
<p>Survival analysis refers to statistical methods used to analyze <strong>time-to-event</strong> data. In other words how long it takes for a specific event (such as death, relapse, or recovery) to occur. Most of the information below are adapted from <span class="citation" data-cites="https://doi.org/10.1016/j.pmrj.2016.04.003">Sainani (<a href="#ref-https://doi.org/10.1016/j.pmrj.2016.04.003" role="doc-biblioref">2016</a>)</span>.</p>
<section id="time" class="level3">
<h3 class="anchored" data-anchor-id="time">1. Time</h3>
<p>The <strong>time variable</strong> represents how long each subject was followed in the study. It begins at the time of entry (e.g., surgery or diagnosis) and ends at either:</p>
<ul>
<li>the time the event happened, or<br>
</li>
<li>the last time the subject was observed (if the event never happened).</li>
</ul>
</section>
<section id="event" class="level3">
<h3 class="anchored" data-anchor-id="event">2. Event</h3>
<p>The <strong>event</strong> is the outcome of interest (most commonly death). It is normally a binary variable that records whether or not a subject had the event of interest.</p>
</section>
<section id="censoring" class="level3">
<h3 class="anchored" data-anchor-id="censoring">3. Censoring</h3>
<p>Subjects who have <strong>not yet experienced the event</strong> by the end of observation are said to be <strong>censored</strong>. Censoring means we know the subject was event-free for a certain time, but not what happened afterward. This allows researchers to use partial information from everyone in the study.</p>
<blockquote class="blockquote">
<p>Example: A patient followed for 5 years without relapse is censored at 5 years — we know they were relapse-free for 5 years, but not beyond potentially due to loss of followup.</p>
</blockquote>
</section>
<section id="incidence-rate" class="level3">
<h3 class="anchored" data-anchor-id="incidence-rate">4. Incidence Rate</h3>
<p>The <strong>incidence rate</strong> measures how frequently new events occur over time. <span class="math display">\[\begin{equation*}
    \text{Incidence rate} = \frac{\text{Number of events}}{\text{Total person-time at risk}}
\end{equation*}\]</span> It is often expressed per 100 person-years. For example, an incidence rate of 5 deaths per 100 person-years means 5 deaths are expected for every 100 years of follow-up time.</p>
</section>
<section id="survival-curve" class="level3">
<h3 class="anchored" data-anchor-id="survival-curve">5. Survival Curve</h3>
<p>A <strong>Kaplan–Meier curve</strong> shows the estimated probability of surviving over time. The curve starts at 100% (everyone is event-free initially) and decreases as events occur.<br>
- The <strong>y-axis</strong> shows survival probability (from 1 to 0).<br>
- The <strong>x-axis</strong> shows time since entry.<br>
- The curve steps downward as events accumulate.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://content.theinformationlab.co.uk/images/2020/06/image-1-1024x493.png" class="img-fluid figure-img"></p>
<figcaption>A cartoon example of survival curve showing the survival of ten biscuits. This figure is taken from <span class="citation" data-cites="lockwood2020survival">Lockwood (<a href="#ref-lockwood2020survival" role="doc-biblioref">2020</a>)</span></figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <strong>steeper</strong> the curve, the <strong>higher</strong> the event rate; if two curves diverge, it suggests a difference in survival between groups.</p>
</div>
</div>
</section>
</section>
<section id="analysis" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="data-wrangling" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="data-wrangling">Data wrangling</h3>
<p>Here we: 1. Load the Melanoma dataset. 2. Convert time from days to years. 3. Collapse original status into a binary event indicator (status_event). 4. Create factor variables for ulceration, sex, and tumor thickness group. 5. Create age tertiles.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p><strong>Note:</strong><br>
In this analysis we treat <strong>all deaths</strong> (from melanoma or other causes) as events when defining our outcome.</p>
</div></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>melanoma_raw <span class="ot">&lt;-</span> MASS<span class="sc">::</span>Melanoma</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>melanoma <span class="ot">&lt;-</span> melanoma_raw <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert follow-up time to years</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">time_years =</span> time <span class="sc">/</span> <span class="fl">365.25</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># collapse status = 1 or 3 into "death" (1), status = 2 as alive (0)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">status_event =</span> <span class="fu">if_else</span>(status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), <span class="dv">1</span>L, <span class="dv">0</span>L),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ulcer into factor</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">ulcer_factor =</span> <span class="fu">factor</span>(ulcer,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No ulcer"</span>, <span class="st">"Ulcer present"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sex into factor</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">sex_factor =</span> <span class="fu">factor</span>(sex,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># define tumor thickness group</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">thickness_group =</span> <span class="fu">if_else</span>(thickness <span class="sc">&lt;</span> <span class="dv">2</span>, <span class="st">"&lt; 2 mm"</span>, <span class="st">"&gt;= 2 mm"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop rows with missing key variables</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>(time_years, status_event)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># age tertiles</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>melanoma <span class="ot">&lt;-</span> melanoma <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">age_tertile =</span> <span class="fu">ntile</span>(age, <span class="dv">3</span>),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">age_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            age_tertile <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Younger (lowest tertile)"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            age_tertile <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Middle (middle tertile)"</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            age_tertile <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"Older (highest tertile)"</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># distribution of counts</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>melanoma <span class="sc">%&gt;%</span> <span class="fu">count</span>(ulcer_factor, thickness_group, age_group)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ulcer_factor thickness_group                age_group  n
1       No ulcer          &lt; 2 mm  Middle (middle tertile) 27
2       No ulcer          &lt; 2 mm  Older (highest tertile) 25
3       No ulcer          &lt; 2 mm Younger (lowest tertile) 35
4       No ulcer         &gt;= 2 mm  Middle (middle tertile) 11
5       No ulcer         &gt;= 2 mm  Older (highest tertile) 10
6       No ulcer         &gt;= 2 mm Younger (lowest tertile)  7
7  Ulcer present          &lt; 2 mm  Middle (middle tertile) 10
8  Ulcer present          &lt; 2 mm  Older (highest tertile)  5
9  Ulcer present          &lt; 2 mm Younger (lowest tertile)  7
10 Ulcer present         &gt;= 2 mm  Middle (middle tertile) 20
11 Ulcer present         &gt;= 2 mm  Older (highest tertile) 28
12 Ulcer present         &gt;= 2 mm Younger (lowest tertile) 20</code></pre>
</div>
</div>
</section>
<section id="overall-incidence-rate" class="level3">
<h3 class="anchored" data-anchor-id="overall-incidence-rate">Overall incidence rate</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>incidence_overall <span class="ot">&lt;-</span> melanoma <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">deaths =</span> <span class="fu">sum</span>(status_event),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">person_years =</span> <span class="fu">sum</span>(time_years),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">rate_per_py =</span> deaths <span class="sc">/</span> person_years,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">rate_per_100py =</span> <span class="dv">100</span> <span class="sc">*</span> rate_per_py</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>incidence_overall</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  deaths person_years rate_per_py rate_per_100py
1     71     1208.279  0.05876125       5.876125</code></pre>
</div>
</div>
<p>The overall incidence rate is approximately 5.9 deaths per 100 person-years.</p>
</section>
<section id="incidence-rate-by-ulceration-status" class="level3">
<h3 class="anchored" data-anchor-id="incidence-rate-by-ulceration-status">Incidence rate by ulceration status</h3>
<p>Next, we compare incidence rates between those with vs.&nbsp;without ulceration.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>incidence_by_ulcer <span class="ot">&lt;-</span> melanoma <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ulcer_factor) <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">deaths =</span> <span class="fu">sum</span>(status_event),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">person_years =</span> <span class="fu">sum</span>(time_years),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">rate_per_100py =</span> <span class="dv">100</span> <span class="sc">*</span> deaths <span class="sc">/</span> person_years,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>incidence_by_ulcer</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  ulcer_factor  deaths person_years rate_per_100py
  &lt;fct&gt;          &lt;int&gt;        &lt;dbl&gt;          &lt;dbl&gt;
1 No ulcer          23         760.           3.02
2 Ulcer present     48         448.          10.7 </code></pre>
</div>
</div>
<p>In this case the group with ulceration has an incidence rate about 3 times higher.</p>
</section>
<section id="incidence-rate-by-thickness-and-ulceration" class="level3">
<h3 class="anchored" data-anchor-id="incidence-rate-by-thickness-and-ulceration">Incidence rate by thickness and ulceration</h3>
<p>We first visualize distribution of tumor thickness in with ulceration and no ulceration groups.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(melanoma, <span class="fu">aes</span>(<span class="at">x =</span> thickness)) <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">boundary =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>ulcer_factor) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">title    =</span> <span class="st">"Tumor thickness distribution by ulceration status"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Melanoma patients treated surgically in Denmark"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">x        =</span> <span class="st">"Tumor thickness (mm)"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">y        =</span> <span class="st">"Number of patients"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="analysis_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Distribution of tumor thickness (mm) by ulceration status. The histogram shows that in the no ulceration group, more patients tend to have thinner tumor thickness.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>incidence_by_ulcer_thickness <span class="ot">&lt;-</span> melanoma <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(thickness_group, ulcer_factor) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">deaths =</span> <span class="fu">sum</span>(status_event),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">person_years =</span> <span class="fu">sum</span>(time_years),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">rate_per_100py =</span> <span class="dv">100</span> <span class="sc">*</span> deaths <span class="sc">/</span> person_years,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>incidence_by_ulcer_thickness</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  thickness_group ulcer_factor  deaths person_years rate_per_100py
  &lt;chr&gt;           &lt;fct&gt;          &lt;int&gt;        &lt;dbl&gt;          &lt;dbl&gt;
1 &lt; 2 mm          No ulcer          14         558.           2.51
2 &lt; 2 mm          Ulcer present      6         145.           4.12
3 &gt;= 2 mm         No ulcer           9         202.           4.44
4 &gt;= 2 mm         Ulcer present     42         302.          13.9 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    incidence_by_ulcer_thickness,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> thickness_group,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> rate_per_100py,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> ulcer_factor</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">title    =</span> <span class="st">"Incidence rate of death by tumor thickness and ulceration"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Rates expressed per 100 person-years of follow-up"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">x        =</span> <span class="st">"Tumor thickness group"</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">y        =</span> <span class="st">"Incidence rate (deaths per 100 person-years)"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill     =</span> <span class="st">"Ulceration"</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="analysis_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Incidence rates of death by tumor thickness group and ulceration status. When ulcer is present, incidence rates tend to be higher. When both tumor thickness &gt;=2 mm and there is a presence of ulceration, the incidence rate is significantly higher compared to all 3 other groups.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="kaplanmeier-curves-by-ulceration" class="level3">
<h3 class="anchored" data-anchor-id="kaplanmeier-curves-by-ulceration">Kaplan–Meier curves by ulceration</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fit_ulcer <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_years, status_event) <span class="sc">~</span> ulcer_factor, <span class="at">data =</span> melanoma)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>km_ulcer_df <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(fit_ulcer) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ulcer_factor =</span> <span class="fu">gsub</span>(<span class="st">"ulcer_factor="</span>, <span class="st">""</span>, strata))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(km_ulcer_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">color =</span> ulcer_factor)) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">title    =</span> <span class="st">"Survival after melanoma surgery by ulceration status"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Kaplan–Meier estimates using all-cause mortality as the event"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">x        =</span> <span class="st">"Time since surgery (years)"</span>,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">y        =</span> <span class="st">"Estimated survival probability"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">color    =</span> <span class="st">"Ulceration"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="analysis_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Kaplan–Meier survival curves by ulceration status. The curves diverge which suggests there is a difference in survival probabilities between patients with ulceration and without.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_ulcer)<span class="sc">$</span>table</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                           records n.max n.start events     rmean se(rmean)
ulcer_factor=No ulcer          115   115     115     23 12.288255 0.5460706
ulcer_factor=Ulcer present      90    90      90     48  8.063745 0.7028958
                             median  0.95LCL 0.95UCL
ulcer_factor=No ulcer            NA       NA      NA
ulcer_factor=Ulcer present 6.176591 4.150582      NA</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time_years, status_event) <span class="sc">~</span> ulcer_factor, <span class="at">data =</span> melanoma)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time_years, status_event) ~ ulcer_factor, 
    data = melanoma)

                             N Observed Expected (O-E)^2/E (O-E)^2/V
ulcer_factor=No ulcer      115       23     44.5      10.4      27.9
ulcer_factor=Ulcer present  90       48     26.5      17.3      27.9

 Chisq= 27.9  on 1 degrees of freedom, p= 1e-07 </code></pre>
</div>
</div>
<p>The median survival time for the ulcerated group was about 6.2 years. The log-rank test comparing two curves was highly significant (<span class="math inline">\(p = 1 \times 10^{-7}\)</span>), indicating strong evidence of worse survival among those with ulceration.</p>
</section>
<section id="kaplanmeier-curves-by-tumor-thickness-and-ulceration" class="level3">
<h3 class="anchored" data-anchor-id="kaplanmeier-curves-by-tumor-thickness-and-ulceration">Kaplan–Meier curves by tumor thickness and ulceration</h3>
<p>Next we add in tumor thickness and inspect the survival curves.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fit_thick_ulcer <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Surv</span>(time_years, status_event) <span class="sc">~</span> thickness_group <span class="sc">+</span> ulcer_factor,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> melanoma</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>km_thick_ulcer_df <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(fit_thick_ulcer) <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> <span class="fu">gsub</span>(<span class="st">"thickness_group="</span>, <span class="st">""</span>, strata),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">group =</span> <span class="fu">gsub</span>(<span class="st">"ulcer_factor="</span>, <span class="st">""</span>, group)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(km_thick_ulcer_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Survival after melanoma surgery by thickness and ulceration"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Kaplan–Meier estimates using all-cause mortality as the event"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Time since surgery (years)"</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Estimated survival probability"</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Group"</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="analysis_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Kaplan–Meier survival curves by ulceration status and tumor thickness. The curve representing patients with a tumor thickness &gt;= 2mm and ulceration diverge significantly from all other survival curves.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time_years, status_event) <span class="sc">~</span> thickness_group <span class="sc">+</span> ulcer_factor, <span class="at">data =</span> melanoma)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time_years, status_event) ~ thickness_group + 
    ulcer_factor, data = melanoma)

                                                     N Observed Expected
thickness_group=&lt; 2 mm, ulcer_factor=No ulcer       87       14    33.24
thickness_group=&lt; 2 mm, ulcer_factor=Ulcer present  22        6     8.49
thickness_group=&gt;= 2 mm, ulcer_factor=No ulcer      28        9    11.22
thickness_group=&gt;= 2 mm, ulcer_factor=Ulcer present 68       42    18.06
                                                    (O-E)^2/E (O-E)^2/V
thickness_group=&lt; 2 mm, ulcer_factor=No ulcer          11.138    21.022
thickness_group=&lt; 2 mm, ulcer_factor=Ulcer present      0.728     0.828
thickness_group=&gt;= 2 mm, ulcer_factor=No ulcer          0.438     0.523
thickness_group=&gt;= 2 mm, ulcer_factor=Ulcer present    31.745    42.996

 Chisq= 44.4  on 3 degrees of freedom, p= 1e-09 </code></pre>
</div>
</div>
<p>Again we observed a highly significant log-rank test p-value (<span class="math inline">\(1 \times 10^{-9}\)</span>), indicating there is significant difference in survival among 4 groups.</p>
</section>
<section id="survival-by-age-tertiles" class="level3">
<h3 class="anchored" data-anchor-id="survival-by-age-tertiles">Survival by age tertiles</h3>
<p>Lasly we investigate whether different age groups have different survival outcomes after melanoma surgery.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fit_age <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time_years, status_event) <span class="sc">~</span> age_group,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> melanoma</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>km_age_df <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(fit_age) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age_group =</span> <span class="fu">gsub</span>(<span class="st">"age_group="</span>, <span class="st">""</span>, strata))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(km_age_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> estimate, <span class="at">color =</span> age_group)) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_step</span>() <span class="sc">+</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">title    =</span> <span class="st">"Survival after melanoma surgery by age tertile"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Kaplan–Meier estimates using all-cause mortality as the event"</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">x        =</span> <span class="st">"Time since surgery (years)"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">y        =</span> <span class="st">"Estimated survival probability"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">color    =</span> <span class="st">"Age group"</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="analysis_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Kaplan–Meier survival curves by age tertile. The youngest group seems to have the highest estimated survival probability towards the end of the study, whereas the middle age group and the elder group showed worse survival.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_age)<span class="sc">$</span>table</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                   records n.max n.start events     rmean
age_group=Middle (middle tertile)       68    68      68     22 10.569057
age_group=Older (highest tertile)       68    68      68     30  9.226518
age_group=Younger (lowest tertile)      69    69      69     19 11.634685
                                   se(rmean)   median  0.95LCL 0.95UCL
age_group=Middle (middle tertile)  0.7875148       NA 8.711841      NA
age_group=Older (highest tertile)  0.8232380 7.616701 5.092402      NA
age_group=Younger (lowest tertile) 0.6965044       NA       NA      NA</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time_years, status_event) <span class="sc">~</span> age_group, <span class="at">data =</span> melanoma)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time_years, status_event) ~ age_group, 
    data = melanoma)

                                    N Observed Expected (O-E)^2/E (O-E)^2/V
age_group=Middle (middle tertile)  68       22     24.5     0.259     0.396
age_group=Older (highest tertile)  68       30     20.0     4.948     7.004
age_group=Younger (lowest tertile) 69       19     26.4     2.093     3.365

 Chisq= 7.4  on 2 degrees of freedom, p= 0.02 </code></pre>
</div>
</div>
<p>The log-rank test for age tertile is also significant (<span class="math inline">\(p = 0.02\)</span>), showing that there is a significant difference in survival distributions among 3 different age groups.</p>
</section>
</section>
<section id="summary-of-results" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-results">Summary of Results</h2>
<p>In this analysis of 205 melanoma patients who underwent surgery, we estimated an overall incidence rate of death of about 5.9 deaths per 100 person-years. Patients with ulcerated tumors had a substantially higher incidence rate and worse Kaplan–Meier survival curves than those without ulceration; the incidence rate ratio was about 3.5, and the log-rank test comparing survival curves was highly significant (<span class="math inline">\(p=1 \times 10^{-7}\)</span>). When inspecting tumor thickness and ulceration together, patients with ulceration and a higher tumor thickness showed significantly worse survival as well. Older age tertiles seem to be associated with worse survival, which is consistent with known prognostic factors in many healthcare problems as older patients tend to be more vulnerable to malignant diseases as well as complications after surgery. Altogether the analysis demonstrated potential risk factors for worse survival after melanoma surgery.</p>
</section>
<section id="functions-used" class="level2">
<h2 class="anchored" data-anchor-id="functions-used">Functions used</h2>
<p>Below is a list of the core functions used from selected packages:</p>
<section id="dplyr" class="level3">
<h3 class="anchored" data-anchor-id="dplyr">dplyr</h3>
<ul>
<li><code>mutate()</code></li>
<li><code>group_by()</code><br>
</li>
<li><code>summarise()</code></li>
<li><code>count()</code></li>
<li><code>ntile()</code></li>
<li><code>case_when()</code></li>
</ul>
</section>
<section id="tidyr" class="level3">
<h3 class="anchored" data-anchor-id="tidyr">tidyr</h3>
<ul>
<li><code>drop_na()</code></li>
</ul>
</section>
<section id="ggplot2" class="level3">
<h3 class="anchored" data-anchor-id="ggplot2">ggplot2</h3>
<ul>
<li><code>ggplot()</code></li>
<li><code>geom_histogram()</code></li>
<li><code>geom_step()</code><br>
</li>
<li><code>geom_col()</code></li>
<li><code>facet_wrap()</code><br>
</li>
<li><code>theme_minimal()</code></li>
</ul>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-andersen1993" class="csl-entry" role="listitem">
Andersen, Per K., Ørnulf Borgan, Richard D. Gill, and Niels Keiding. 1993. <em>Statistical Models Based on Counting Processes</em>. New York: Springer.
</div>
<div id="ref-lockwood2020survival" class="csl-entry" role="listitem">
Lockwood, Gwilym. 2020. <span>“Survival Analysis in Alteryx and Tableau.”</span> 2020. <a href="https://www.theinformationlab.co.uk/community/blog/survival-analysis-in-alteryx-and-tableau/">https://www.theinformationlab.co.uk/community/blog/survival-analysis-in-alteryx-and-tableau/</a>.
</div>
<div id="ref-https://doi.org/10.1016/j.pmrj.2016.04.003" class="csl-entry" role="listitem">
Sainani, Kristin L. 2016. <span>“Introduction to Survival Analysis.”</span> <em>PM&amp;R</em> 8 (6): 580–85. https://doi.org/<a href="https://doi.org/10.1016/j.pmrj.2016.04.003">https://doi.org/10.1016/j.pmrj.2016.04.003</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>